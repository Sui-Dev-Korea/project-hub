name: reviewer-bot

on:
  schedule:
    - cron: "2-59/5 * * * *"  # 2분, 7분, 12분, …, 57분 (정각 부하 회피)
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  repository-projects: write

env:
  TZ: Asia/Seoul
  BOT_NAME: reviewer
  GH_TOKEN: ${{ secrets.BOT_TOKEN }}   # gh CLI용 PAT (org projects/graphQL 접근 포함)

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          curl -sSL https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Install GitHub CLI
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi
          # gh CLI는 GH_TOKEN을 사용해 인증하므로 값이 비어있다면 GITHUB_TOKEN으로 폴백
          if [ -z "${GH_TOKEN:-}" ]; then
            export GH_TOKEN="${GITHUB_TOKEN}"
          fi

      - name: Find managed projects
        id: list
        run: |
          set -euo pipefail
          ls .github/config/${{ env.BOT_NAME }}/*.yml 2>/dev/null | sed 's#.*/##; s#\.yml$##' > projects.txt || true
          echo "count=$(wc -l < projects.txt | tr -d ' ')" >> $GITHUB_OUTPUT

      - name: No managed projects? (short-circuit)
        if: ${{ steps.list.outputs.count == '0' }}
        run: echo "No configs under .github/config/${{ env.BOT_NAME }} — nothing to do."

      - name: Loop over projects
        if: ${{ steps.list.outputs.count != '0' }}
        run: |
          set -euo pipefail

          while read -r KEY; do
            [ -z "$KEY" ] && continue
            echo "::group::Project = $KEY"

            PROJECT_ID=""
            CFG=".github/config/${{ env.BOT_NAME }}/${KEY}.yml"
            ST="state/${{ env.BOT_NAME }}/${KEY}.json"
            mkdir -p "state/${{ env.BOT_NAME }}"
            [ -f "$ST" ] || echo '{}' > "$ST"

            ORG=$(yq -r '.project_org // ""' "$CFG")
            NUM=$(yq -r '.project_number // ""' "$CFG")
            if [ -z "$PROJECT_ID" ] && [ -n "$ORG" ] && [ -n "$NUM" ]; then
              Q='query($org:String!,$num:Int!){
                organization(login:$org){
                  projectV2(number:$num){
                    id title
                  }
                }
              }'
              PROJECT_ID=$(jq -nc --arg q "$Q" --arg org "$ORG" --argjson num "$NUM" \
                '{query:$q,variables:{org:$org,num:$num}}' | gh api graphql --input - \
                | jq -r '.data.organization.projectV2.id // empty')
            fi

            if [ -z "$PROJECT_ID" ]; then
              echo "[ERR] project_org/number 로 Project ID를 찾지 못했습니다. ORG=$ORG NUM=$NUM"
              exit 1
            fi

            REVIEWERS_NEEDED=$(yq -r '.reviewers_needed // 2' "$CFG")
            QUOTA=$(yq -r '.quota_per_sprint // 8' "$CFG")
            SPRINT=$(yq -r '.sprint // "default-sprint"' "$CFG")
            POOL=$(yq -r '(.eligible_pool // [])[]? // ""' "$CFG" | tr '\n' ' ')
            EXC=$(yq -r '(.exclude_rules // [])[]? // ""' "$CFG" | tr '\n' ' ')
            REVIEWERS_NEEDED=$((REVIEWERS_NEEDED + 0))
            QUOTA=$((QUOTA + 0))

            # ---- 프로젝트 스냅샷 (필드 + 아이템) ----
            READ_Q='query($pid:ID!,$after:String){
              node(id:$pid){
                ... on ProjectV2{
                  items(first:50, after:$after){
                    pageInfo{ hasNextPage endCursor }
                    nodes{
                      id
                      content{
                        __typename
                        ... on Issue       { id number title url repository { nameWithOwner } }
                        ... on PullRequest { id number title url repository { nameWithOwner } }
                      }
                      fieldValues(first:50){
                        nodes{
                          __typename
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            field { ... on ProjectV2Field { id name } }
                            name
                          }
                          ... on ProjectV2ItemFieldTextValue {
                            field { ... on ProjectV2Field { id name } }
                            text
                          }
                          ... on ProjectV2ItemFieldUserValue {
                            field { ... on ProjectV2Field { id name } }
                            users(first:10){ nodes{ login } }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }'
            echo '{"data":{"node":{"items":{"nodes":[]}}}}' > proj.json
            AFTER=""
            while :; do
              jq -nc --arg q "$READ_Q" --arg pid "$PROJECT_ID" --arg after "$AFTER" \
                '{query:$q, variables:{pid:$pid, after:($after | if length>0 then . else null end)}}' \
              | gh api graphql --input - > page.json

              jq --slurpfile p page.json '
                .data.node.items.nodes += ($p[0].data.node.items.nodes)
              ' proj.json > _tmp.json && mv _tmp.json proj.json

              HAS_NEXT=$(jq -r '.data.node.items.pageInfo.hasNextPage' page.json)
              AFTER=$(jq -r '.data.node.items.pageInfo.endCursor // ""' page.json)
              [ "$HAS_NEXT" = "true" ] || break
            done
            rm -f page.json

            # ---- Status 옵션 조회 (대소문자/공백 안전) ----
            FQ='query($pid:ID!){
              node(id:$pid){
                ... on ProjectV2{
                  fields(first:50){
                    nodes{
                      __typename
                      ... on ProjectV2Field { id name dataType }
                      ... on ProjectV2SingleSelectField { id name options { name } }
                    }
                  }
                }
              }
            }'
            jq -nc --arg q "$FQ" --arg pid "$PROJECT_ID" \
              '{query:$q, variables:{pid:$pid}}' \
            | gh api graphql --input - > fields.json

            STATUS_OPTS_JSON=$(jq -c '
              [.data.node.fields.nodes[]
               | select((.name|test("(?i)^status\\s*$")) and .__typename=="ProjectV2SingleSelectField")
               | .options[].name]
            ' fields.json)
            IN_REVIEW_COUNT=$(jq -r --argjson sopts "${STATUS_OPTS_JSON:-[]}" '
              [.data.node.items.nodes[]
               | {fields: .fieldValues.nodes}
               | select(
                   (.fields
                     | map(select(.__typename=="ProjectV2ItemFieldSingleSelectValue"))
                     | map(.name // "" | gsub("^\\s+|\\s+$";"") | ascii_downcase)
                   ) as $vals
                   | ($vals | index("in review"))
                   and (
                     (.fields
                       | map(select(.__typename=="ProjectV2ItemFieldSingleSelectValue"))
                       | map(.name // "")) as $names
                     | any($names[]; ($sopts | index(.)))
                   )
                 )
              ] | length
            ' proj.json)
            STATUS_DIST=$(jq -r '
              [.data.node.items.nodes[]
               | .fieldValues.nodes[]
               | select(.__typename=="ProjectV2ItemFieldSingleSelectValue")
               | (.name // "" | gsub("^\\s+|\\s+$";"") | ascii_downcase)
               | select(.!="")
              ] | sort | unique | join(", ")
            ' proj.json)
            echo "Status=In review count: ${IN_REVIEW_COUNT} (distinct: ${STATUS_DIST:-none})"

            RV_FIELD_ID=$(jq -r '.data.node.fields.nodes[] | select(.name=="Reviewers(auto)") | .id' fields.json)
            if [ -z "$RV_FIELD_ID" ] || [ "$RV_FIELD_ID" = "null" ]; then
              echo "WARN: Reviewers(auto) 필드가 없어 $KEY 스킵"
              echo "::endgroup::"
              continue
            fi

            # ---- state 초기 병합 & 스프린트 전환 처리 ----
            jq -s '.[0] * .[1]' <(echo '{"quota_usage":{},"processed_card_ids":[]}' ) "$ST" > _st.json || echo '{}' > _st.json
            mv _st.json "$ST"

            CUR=$(jq -r '.sprint // empty' "$ST")
            if [ "$CUR" != "$SPRINT" ]; then
              jq --arg s "$SPRINT" '
                .sprint = $s
                | .quota_per_sprint = '"$QUOTA"'
                | .quota_usage = {}
                | .processed_card_ids = []
              ' "$ST" > _st.json && mv _st.json "$ST"
            fi

            # ---- 대상 아이템 추출 ----
            jq -r --argjson sopts "${STATUS_OPTS_JSON:-[]}" --argjson needed '"$REVIEWERS_NEEDED"' '
              .data.node.items.nodes[]
              | {id, content: .content, fields: .fieldValues.nodes}

              # Reviewers(auto) 안전 추출 → 없으면 "" 로 대체
              | (
                  [ .fields[]
                    | select((.field.name? // "") | test("(?i)^reviewers\\(auto\\)\\s*$"))
                    | .text // ""
                  ] | .[0] // ""
                ) as $rv_raw
              | ($rv_raw
                  | gsub("[\\r\\n]+"; ",")
                  | gsub("@";"")
                  | split(",")
                  | map(gsub("\\s+"; "") | ascii_downcase)
                  | map(select(. != ""))
                ) as $rv_arr
              | ($rv_arr | length) as $rv_count

              # Status = "In review" 인 카드만 (대소문자 무시 + 옵션 검증)
              | select(
                  (.fields
                    | map(select(.__typename=="ProjectV2ItemFieldSingleSelectValue"))
                    | map(.name // "" | gsub("^\\s+|\\s+$";"") | ascii_downcase)
                  ) as $vals
                  | ($vals | index("in review"))
                  and (
                    (.fields
                      | map(select(.__typename=="ProjectV2ItemFieldSingleSelectValue"))
                      | map(.name // "")) as $names
                    | any($names[]; ($sopts | index(.)))
                  )
                )

              # 필요한 리뷰어 수보다 적게 배정된 카드만
              | select($rv_count < $needed)

              | {id, content, fields, reviewers:$rv_arr, rv_raw:$rv_raw}
              | @base64
            ' proj.json > items.b64

            if [ ! -s items.b64 ]; then
              echo "No 'In review' items without Reviewers(auto) — $KEY"
              echo "::endgroup::"
              continue
            fi

            # ---- 아이템 처리 ----
            trap 'rm -f "$ST.tmp" _tmp.json 2>/dev/null || true' EXIT ERR
            while read -r ROW; do
              J=$(echo "$ROW" | base64 -d)
              ITEM_ID=$(echo "$J" | jq -r '.id')
              ASSIGNEE=$(echo "$J" | jq -r '
                (.fields[] | select(.field.name=="Assignee")  | .users.nodes[0].login // empty),
                (.fields[] | select(.field.name=="Assignees") | .users.nodes[0].login // empty)
              ' | head -n1)
              mapfile -t EXISTING < <(echo "$J" | jq -r '.reviewers[]?')
              EXISTING_COUNT=${#EXISTING[@]}
              NEED=$((REVIEWERS_NEEDED - EXISTING_COUNT))

              if [ -z "$ASSIGNEE" ]; then
                echo "Skip card $ITEM_ID (no Assignee)"
                continue
              fi

              CTYPE=$(echo "$J" | jq -r '.content.__typename // "DRAFT"')
              ISSUE_URL=$(echo "$J" | jq -r '.content.url // ""')
              REPO_NWO=$(echo "$J" | jq -r '.content.repository.nameWithOwner // ""')

              CAND=()
              for u in $POOL; do
                [ -z "$u" ] && continue
                echo " $EXC " | grep -qw " $u " && continue
                [ "$u" = "$ASSIGNEE" ] && continue
                printf "%s\n" "${EXISTING[@]}" | grep -qx "$u" && continue
                CAND+=("$u")
              done

              PICKS=()
              TMP_ST="$ST.tmp"
              cp "$ST" "$TMP_ST"

              for i in $(seq 1 $NEED); do
                ELIG=()
                MIN=999999
                declare -A USED_MAP
                for u in "${CAND[@]}"; do
                  printf "%s\n" "${PICKS[@]}" | grep -qx "$u" && continue
                  USED_MAP["$u"]=${USED_MAP["$u"]-0}
                  USED=$(jq -r --arg u "$u" '.quota_usage[$u] // 0' "$TMP_ST")
                  USED_MAP["$u"]=$USED
                  [ "$USED" -lt "$QUOTA" ] || continue
                  ELIG+=("$u")
                  [ "$USED" -lt "$MIN" ] && MIN="$USED"
                done
                [ ${#ELIG[@]} -eq 0 ] && break
                TIER=()
                for u in "${ELIG[@]}"; do
                  if [ "${USED_MAP[$u]}" -eq "$MIN" ]; then
                    TIER+=("$u")
                  fi
                done
                PICK=$(printf "%s\n" "${TIER[@]}" | shuf -n1)
                PICKS+=("$PICK")
                jq --arg u "$PICK" '.quota_usage[$u] = ((.quota_usage[$u] // 0) + 1)' "$TMP_ST" > _tmp.json && mv _tmp.json "$TMP_ST"
              done
              COUNT=${#PICKS[@]}
              rm -f "$TMP_ST"
              if [ $COUNT -eq 0 ]; then
                # 경고 코멘트는 일단 비활성화
                # NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                # MSG="❌ [AUTO][$NOW][$KEY] 리뷰어 배정 실패(쿼터/제외 충돌)"
                # if [ "$CTYPE" = "Issue" ] || [ "$CTYPE" = "PullRequest" ]; then
                #   gh api repos/$REPO_NWO/issues/$(basename "$ISSUE_URL")/comments \
                #     --raw-field body="$MSG" >/dev/null || true
                # fi
                continue
              fi

              ALL=("${EXISTING[@]}" "${PICKS[@]}")
              CLEANED=()
              for a in "${ALL[@]}"; do
                a=$(printf "%s" "$a" | tr -d '\r\n' | sed 's/^@//')
                [ -n "$a" ] && CLEANED+=("$a")
              done
              REV=$(printf "%s" "$(printf "@%s\n" "${CLEANED[@]}" | paste -sd', ' -)")

              # Reviewers(auto) 텍스트 필드 업데이트
              M='mutation($pid:ID!,$item:ID!,$fid:ID!,$text:String!){
                updateProjectV2ItemFieldValue(input:{
                  projectId:$pid,
                  itemId:$item,
                  fieldId:$fid,
                  value:{text:$text}
                }){
                  clientMutationId
                }
              }'
              for vname in PROJECT_ID ITEM_ID RV_FIELD_ID; do
                eval "v=\${$vname}"
                if [ -z "$v" ]; then
                  echo "FATAL: $vname is empty" >&2
                  exit 1
                fi
              done
              jq -nc \
                --arg q "$M" \
                --arg pid  "$PROJECT_ID" \
                --arg item "$ITEM_ID" \
                --arg fid  "$RV_FIELD_ID" \
                --arg text "$REV" \
                '{query:$q, variables:{pid:$pid, item:$item, fid:$fid, text:$text}}' \
              | gh api graphql --input - >/dev/null

              if [ $COUNT -ge 1 ]; then
                P0="${PICKS[0]}"
                USED0=$(jq -r --arg u "$P0" '.quota_usage[$u] // 0' "$ST")
                NEW0=$((USED0 + 1))
                LINE0="@${P0} (${NEW0}/${QUOTA})"
              fi
              if [ $COUNT -ge 2 ]; then
                P1="${PICKS[1]}"
                USED1=$(jq -r --arg u "$P1" '.quota_usage[$u] // 0' "$ST")
                NEW1=$((USED1 + 1))
                LINE1="@${P1} (${NEW1}/${QUOTA})"
              fi

              NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

              if [ $COUNT -eq 1 ]; then
                printf -v MSG '✅ [AUTO][%s][%s] 리뷰어 자동 배정\n스프린트: %s\n\n%s' \
                  "$NOW" "$KEY" "$SPRINT" "$LINE0"
              else
                printf -v MSG '✅ [AUTO][%s][%s] 리뷰어 자동 배정\n스프린트: %s\n\n%s\n%s' \
                  "$NOW" "$KEY" "$SPRINT" "$LINE0" "$LINE1"
              fi

              # 줄바꿈 처리를 위해 -f body="$MSG" 대신 --raw-field body="$MSG" 사용
              if [ "$CTYPE" = "Issue" ] || [ "$CTYPE" = "PullRequest" ]; then
                gh api repos/$REPO_NWO/issues/$(basename "$ISSUE_URL")/comments \
                  --raw-field body="$MSG" >/dev/null || true
              fi

              for u in "${PICKS[@]}"; do
                jq --arg u "$u" '.quota_usage[$u] = ((.quota_usage[$u] // 0) + 1)' "$ST" > _st.json && mv _st.json "$ST"
              done
              TOTAL=$((EXISTING_COUNT + COUNT))
              jq --arg s "$SPRINT" --argjson q "$QUOTA" '
                .last_run_at = "'$NOW'"
                | .sprint = $s
                | .quota_per_sprint = $q
              ' "$ST" > _st.json && mv _st.json "$ST"
              if [ $TOTAL -ge $REVIEWERS_NEEDED ]; then
                jq --arg id "$ITEM_ID" '
                  .processed_card_ids |= ( . + [$id] | unique )
                ' "$ST" > _st.json && mv _st.json "$ST"
              fi

            done < items.b64
            trap - EXIT ERR

            git config --global safe.directory "$GITHUB_WORKSPACE"
            git config user.name  "project-hub-bot"
            git config user.email "bot@users.noreply.github.com"

            if ! git ls-files --error-unmatch state >/dev/null 2>&1; then
              mkdir -p state
              touch state/.gitkeep
              git add state/.gitkeep
              git commit -m "init(state): track state directory" || true
              git pull --rebase || true
              git push || true
            fi

            git add -A state/
            if git diff --cached --quiet -- state/ ; then
              echo "No state changes to commit"
            else
              git commit -m "state(${KEY}): update @ ${GITHUB_RUN_ID}" || true
              git pull --rebase || true
              git push || (sleep 2 && git pull --rebase && git push) || true
            fi

            echo "::endgroup::"
          done < projects.txt
